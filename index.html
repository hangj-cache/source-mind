<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„‘æºå®šä½æ¨¡æ‹Ÿå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è®¾ç½® Inter å­—ä½“å’Œæ·±è‰²ä¸»é¢˜ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 */
            color: #e2e8f0; /* Slate-200 */
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-400">ğŸ§  è„‘æºå®šä½æ¨¡æ‹Ÿå™¨</h1>
            <p class="text-gray-400">ä¸Šä¼ æ•°æ®æ–‡ä»¶ï¼Œé€šè¿‡ Python åç«¯è¿è¡Œæº¯æºç®—æ³•å¹¶è·å– .mat ç»“æœã€‚</p>
        </header>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
        <div id="upload-section" class="bg-slate-800 p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">1. é…ç½®ä¸æ•°æ®æ–‡ä»¶ä¸Šä¼ </h2>
            
            <!-- ç®—æ³•é€‰æ‹© -->
            <div class="mb-6 space-y-2">
                <label for="algorithm-select" class="block text-sm font-medium text-yellow-300">é€‰æ‹©æº¯æºç®—æ³•</label>
                <select id="algorithm-select" 
                        class="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="sbl">Sparse Bayesian Learning (SBL)</option>
                    <option value="wmne">Weighted Minimum Norm Estimate (wMNE)</option>
                    <option value="loreta">Low-Resolution Tomography (LORETA)</option>
                    <option value="duvl1n">Deep Unfold NetWork (DUV-L1N)</option>
                </select>
            </div>
            
            <!-- æ–‡ä»¶è¾“å…¥ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label for="file-gain" class="block text-sm font-medium">Gain/Model (.mat)</label>
                    <input type="file" id="file-gain" accept=".mat" class="w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-600 file:text-white
                        hover:file:bg-indigo-700
                        rounded-lg p-2 border border-slate-700">
                </div>
                
                <div class="space-y-2">
                    <label for="file-b-storage" class="block text-sm font-medium">B/TBFs Data (.mat)</label>
                    <input type="file" id="file-b-storage" accept=".mat" class="w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-600 file:text-white
                        hover:file:bg-indigo-700
                        rounded-lg p-2 border border-slate-700">
                </div>

                <!-- åªéœ€è¦ä¸¤ä¸ªå…³é”®æ–‡ä»¶ï¼ŒLå’ŒCortexå¯ä»¥åˆå¹¶åˆ°Gainä¸­æˆ–ç”±åç«¯å¤„ç† -->
                <div class="space-y-2">
                    <label for="file-L" class="block text-sm font-medium">L Matrix (.mat)</label>
                    <input type="file" id="file-L" accept=".mat" class="w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-600 file:text-white
                        hover:file:bg-indigo-700
                        rounded-lg p-2 border border-slate-700">
                </div>
                
                <div class="space-y-2">
                    <label for="file-cortex" class="block text-sm font-medium">Cortex (.mat)</label>
                    <input type="file" id="file-cortex" accept=".mat" class="w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-600 file:text-white
                        hover:file:bg-indigo-700
                        rounded-lg p-2 border border-slate-700">
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button id="run-button" 
                        class="px-8 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg transition duration-200 hover:bg-green-600 active:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    ğŸš€ å¯åŠ¨è®¡ç®—å¹¶ä¸‹è½½ç»“æœ
                </button>
            </div>
        </div>

        <!-- æ¨¡æ‹Ÿè¾“å‡ºåŒº -->
        <div id="output-section" class="bg-slate-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">2. çŠ¶æ€æ§åˆ¶å°</h2>
            <div id="output-console" class="bg-black text-lime-400 font-mono text-sm p-3 h-64 overflow-y-scroll rounded-lg border border-slate-700">
                å‡†å¤‡å°±ç»ª... è¯·ä¸Šä¼ æ–‡ä»¶ã€é€‰æ‹©ç®—æ³•å¹¶ç‚¹å‡»è¿è¡ŒæŒ‰é’®ã€‚
            </div>
        </div>
    </div>

    <script>
        const outputConsole = document.getElementById('output-console');
        const runButton = document.getElementById('run-button');
        const algorithmSelect = document.getElementById('algorithm-select');
        const API_URL = 'http://127.0.0.1:5000/run_localization'; // ** æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æŒ‡å‘æ‚¨æœ¬åœ°è¿è¡Œçš„ Flask æœåŠ¡å™¨åœ°å€ **

        function log(message, type = 'info') {
            const span = document.createElement('span');
            let color = 'text-lime-400';
            if (type === 'error') color = 'text-red-400';
            if (type === 'success') color = 'text-green-400';
            if (type === 'highlight') color = 'text-yellow-400';
            
            span.className = `${color} block whitespace-pre-wrap`;
            span.textContent = message;
            outputConsole.appendChild(span);
            outputConsole.scrollTop = outputConsole.scrollHeight;
        }

        function clearConsole() {
            outputConsole.innerHTML = '';
            log("æ­£åœ¨å¯åŠ¨æº¯æºè®¡ç®—...", 'info');
        }

        async function runLocalization() {
            clearConsole();
            runButton.disabled = true;

            const files = {
                gain: document.getElementById('file-gain').files[0],
                L: document.getElementById('file-L').files[0],
                bStorage: document.getElementById('file-b-storage').files[0],
                cortex: document.getElementById('file-cortex').files[0],
            };
            const algorithm = algorithmSelect.value;
            
            if (!files.gain || !files.bStorage || !files.cortex || !files.L) {
                log('âŒ é”™è¯¯ï¼šGain/Model æ–‡ä»¶ ï¼Œ B/TBFs Data æ–‡ä»¶ ï¼ŒL æ–‡ä»¶å’ŒCortex æ–‡ä»¶æ˜¯å¿…éœ€çš„ã€‚', 'error');
                runButton.disabled = false;
                return;
            }

            const formData = new FormData();
            formData.append('algorithm', algorithm);
            formData.append('model_file', files.gain);
            formData.append('data_file', files.bStorage);
            formData.append('l_file',files.L)
            formData.append('cortex_file',files.cortex)
            // if (files.L) formData.append('l_file', files.L);
            // if (files.cortex) formData.append('cortex_file', files.cortex);
            
            log(`--- 1. æ­£åœ¨å‘é€è¯·æ±‚è‡³åç«¯ (${API_URL}) ---`);
            log(`   é€‰ä¸­ç®—æ³•: ${algorithm}`);
            log(`   Gain æ–‡ä»¶: ${files.gain.name}`);
            log(`   B_Storage æ–‡ä»¶: ${files.bStorage.name}`);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ åç«¯è®¡ç®—å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : ${response.status}`, 'error');
                    log(`   æœåŠ¡å™¨è¿”å›é”™è¯¯ä¿¡æ¯: ${errorText}`, 'error');
                    return;
                }

                // 2. æ¥æ”¶æ–‡ä»¶å¹¶ä¸‹è½½
                log("--- 2. åç«¯è®¡ç®—æˆåŠŸï¼Œæ­£åœ¨ä¸‹è½½ç»“æœæ–‡ä»¶... ---", 'highlight');
                
                const blob = await response.blob();
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'source_results.mat';
                
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameMatch = disposition.match(/filename="(.+?)"/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1];
                    }
                }

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                log(`âœ… æ–‡ä»¶ ${filename} ä¸‹è½½æˆåŠŸï¼`, 'success');

            } catch (error) {
                log(`âŒ è¿æ¥é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ (${error.message})`, 'error');
                log('   è¯·ç¡®ä¿æ‚¨å·²åœ¨æœ¬åœ°è¿è¡Œ Flask æœåŠ¡å™¨ (app.py)ã€‚', 'highlight');
            } finally {
                runButton.disabled = false;
                log("\n" + "=".repeat(40), 'info');
            }
        }

        runButton.addEventListener('click', runLocalization);

        // åˆå§‹åŒ–æ—¶æ‰“å°æ¬¢è¿ä¿¡æ¯
        log("è¯·è¿è¡Œæœ¬åœ° Python æœåŠ¡å™¨ (app.py) æ¥å¯ç”¨ç®—æ³•è®¡ç®—ã€‚", 'info');

    </script>
</body>
</html>